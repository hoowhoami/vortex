import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../models/video.dart';
import '../../services/video_service.dart';
import '../../services/app_settings_service.dart';
import '../../core/theme/app_colors.dart';
import '../../core/constants/app_constants.dart';
import '../../core/utils/app_localizations.dart';
import '../video_detail/video_detail_screen.dart';

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  final PageController _featuredPageController = PageController();

  List<Video> _trendingVideos = [];
  List<Video> _latestMovies = [];
  List<Video> _latestTVShows = [];

  bool _isLoading = true;
  int _currentFeaturedIndex = 0;
  String? _errorMessage;

  @override
  void initState() {
    super.initState();
    _loadContent();
    _setupFeaturedAutoScroll();
  }

  @override
  void dispose() {
    _featuredPageController.dispose();
    super.dispose();
  }

  void _setupFeaturedAutoScroll() {
    Future.delayed(const Duration(seconds: 5), () {
      if (!mounted) return;
      if (_trendingVideos.isEmpty) return;

      final nextPage = (_currentFeaturedIndex + 1) % _trendingVideos.length.clamp(1, 5);
      _featuredPageController.animateToPage(
        nextPage,
        duration: AppConstants.animationSlow,
        curve: Curves.easeInOut,
      );

      _setupFeaturedAutoScroll();
    });
  }

  Future<void> _loadContent() async {
    setState(() {
      _isLoading = true;
      _errorMessage = null;
    });

    try {
      final videoService = context.read<VideoService>();

      // Get trending videos for featured section
      final trendingResult = await videoService.getTrendingVideos(limit: 20);

      if (mounted) {
        setState(() {
          _trendingVideos = trendingResult.list;

          // Split videos by type for different sections
          // Type 1 = Movies, Type 2 = TV Shows
          _latestMovies = trendingResult.list
              .where((video) => video.typeId == 1)
              .take(20)
              .toList();

          _latestTVShows = trendingResult.list
              .where((video) => video.typeId == 2)
              .take(20)
              .toList();

          // If no movies/shows found by type, split the list
          if (_latestMovies.isEmpty && _latestTVShows.isEmpty && trendingResult.list.isNotEmpty) {
            final halfIndex = (trendingResult.list.length / 2).ceil();
            _latestMovies = trendingResult.list.take(halfIndex).toList();
            _latestTVShows = trendingResult.list.skip(halfIndex).toList();
          }

          _isLoading = false;
        });
      }
    } catch (e) {
      if (mounted) {
        setState(() {
          _isLoading = false;
          _errorMessage = e.toString();
        });
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final loc = AppLocalizations.of(context);

    return Scaffold(
      body: SafeArea(
        child: _isLoading
            ? const Center(
                child: CircularProgressIndicator(
                  color: AppColors.accent,
                ),
              )
            : _errorMessage != null
                ? _buildErrorState(loc)
                : RefreshIndicator(
                    onRefresh: _loadContent,
                    color: AppColors.accent,
                    child: CustomScrollView(
                      slivers: [
                        _buildAppBar(),
                        _buildFeaturedSection(),
                        _buildLatestMoviesSection(loc),
                        _buildLatestTVShowsSection(loc),
                        const SliverToBoxAdapter(
                          child: SizedBox(height: AppConstants.spacingLg),
                        ),
                      ],
                    ),
                  ),
      ),
    );
  }

  Widget _buildErrorState(AppLocalizations loc) {
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(AppConstants.spacingLg),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(
              Icons.error_outline,
              size: 64,
              color: AppColors.textSecondary,
            ),
            const SizedBox(height: AppConstants.spacingMd),
            Text(
              '加载失败',
              style: Theme.of(context).textTheme.titleLarge,
            ),
            const SizedBox(height: AppConstants.spacingSm),
            Text(
              _errorMessage ?? '未知错误',
              style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                    color: AppColors.textSecondary,
                  ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: AppConstants.spacingLg),
            ElevatedButton.icon(
              onPressed: _loadContent,
              icon: const Icon(Icons.refresh),
              label: const Text('重试'),
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.accent,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildAppBar() {
    return SliverAppBar(
      floating: true,
      backgroundColor: AppColors.backgroundDark,
      title: Row(
        children: [
          Container(
            padding: const EdgeInsets.symmetric(
              horizontal: 12,
              vertical: 6,
            ),
            decoration: BoxDecoration(
              gradient: AppColors.primaryGradient,
              borderRadius: BorderRadius.circular(AppConstants.radiusSm),
            ),
            child: Text(
              'LUMINA',
              style: Theme.of(context).textTheme.titleLarge?.copyWith(
                    fontWeight: FontWeight.bold,
                    letterSpacing: 2,
                  ),
            ),
          ),
        ],
      ),
      actions: [
        IconButton(
          icon: const Icon(Icons.notifications_outlined),
          onPressed: () {},
        ),
      ],
    );
  }

  Widget _buildFeaturedSection() {
    if (_trendingVideos.isEmpty) return const SliverToBoxAdapter();

    final featuredItems = _trendingVideos.take(5).toList();

    return SliverToBoxAdapter(
      child: Column(
        children: [
          const SizedBox(height: AppConstants.spacingMd),
          SizedBox(
            height: AppConstants.featuredCardHeight,
            child: PageView.builder(
              controller: _featuredPageController,
              onPageChanged: (index) {
                setState(() => _currentFeaturedIndex = index);
              },
              itemCount: featuredItems.length,
              itemBuilder: (context, index) {
                return _buildFeaturedCard(featuredItems[index]);
              },
            ),
          ),
          const SizedBox(height: AppConstants.spacingMd),
          _buildPageIndicator(featuredItems.length),
          const SizedBox(height: AppConstants.spacingLg),
        ],
      ),
    );
  }

  Widget _buildFeaturedCard(Video video) {
    return GestureDetector(
      onTap: () {
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => VideoDetailScreen(video: video),
          ),
        );
      },
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: AppConstants.spacingMd),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(AppConstants.radiusLg),
          child: Stack(
            fit: StackFit.expand,
            children: [
            if (video.pic.isNotEmpty)
              Image.network(
                video.pic,
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Container(
                    color: AppColors.primaryMedium,
                    child: const Icon(Icons.movie, size: 64, color: AppColors.textSecondary),
                  );
                },
              ),
            Container(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                  colors: [
                    Colors.transparent,
                    Colors.black.withValues(alpha: 0.8),
                  ],
                ),
              ),
            ),
            Positioned(
              bottom: AppConstants.spacingLg,
              left: AppConstants.spacingLg,
              right: AppConstants.spacingLg,
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    video.name,
                    style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                    maxLines: 2,
                    overflow: TextOverflow.ellipsis,
                  ),
                  const SizedBox(height: AppConstants.spacingXs),
                  Row(
                    children: [
                      if (video.displayScore > 0) ...[
                        const Icon(Icons.star, color: Colors.amber, size: 16),
                        const SizedBox(width: 4),
                        Text(
                          video.formattedScore,
                          style: const TextStyle(color: Colors.white),
                        ),
                        const SizedBox(width: AppConstants.spacingMd),
                      ],
                      if (video.year != null && video.year!.isNotEmpty)
                        Text(
                          video.year!,
                          style: const TextStyle(color: Colors.white70),
                        ),
                      if (video.remarks != null && video.remarks!.isNotEmpty) ...[
                        const SizedBox(width: AppConstants.spacingMd),
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 8,
                            vertical: 2,
                          ),
                          decoration: BoxDecoration(
                            color: AppColors.accent,
                            borderRadius: BorderRadius.circular(4),
                          ),
                          child: Text(
                            video.remarks!,
                            style: const TextStyle(
                              color: Colors.white,
                              fontSize: 12,
                            ),
                          ),
                        ),
                      ],
                    ],
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
      ),
    );
  }

  Widget _buildPageIndicator(int count) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: List.generate(
        count,
        (index) => Container(
          margin: const EdgeInsets.symmetric(horizontal: 4),
          width: _currentFeaturedIndex == index ? 24 : 8,
          height: 8,
          decoration: BoxDecoration(
            color: _currentFeaturedIndex == index
                ? AppColors.accent
                : AppColors.textTertiary,
            borderRadius: BorderRadius.circular(AppConstants.radiusFull),
          ),
        ),
      ),
    );
  }

  Widget _buildLatestMoviesSection(AppLocalizations loc) {
    if (_latestMovies.isEmpty) return const SliverToBoxAdapter();

    return SliverToBoxAdapter(
      child: Column(
        children: [
          _buildSectionHeader('最新电影', () {}),
          const SizedBox(height: AppConstants.spacingMd),
          SizedBox(
            height: AppConstants.movieCardHeight,
            child: ListView.builder(
              scrollDirection: Axis.horizontal,
              padding: const EdgeInsets.symmetric(
                horizontal: AppConstants.spacingMd,
              ),
              itemCount: _latestMovies.length,
              itemBuilder: (context, index) {
                return Padding(
                  padding: const EdgeInsets.only(
                    right: AppConstants.spacingMd,
                  ),
                  child: _buildVideoCard(_latestMovies[index]),
                );
              },
            ),
          ),
          const SizedBox(height: AppConstants.spacingLg),
        ],
      ),
    );
  }

  Widget _buildLatestTVShowsSection(AppLocalizations loc) {
    if (_latestTVShows.isEmpty) return const SliverToBoxAdapter();

    return SliverToBoxAdapter(
      child: Column(
        children: [
          _buildSectionHeader('最新剧集', () {}),
          const SizedBox(height: AppConstants.spacingMd),
          SizedBox(
            height: AppConstants.movieCardHeight,
            child: ListView.builder(
              scrollDirection: Axis.horizontal,
              padding: const EdgeInsets.symmetric(
                horizontal: AppConstants.spacingMd,
              ),
              itemCount: _latestTVShows.length,
              itemBuilder: (context, index) {
                return Padding(
                  padding: const EdgeInsets.only(
                    right: AppConstants.spacingMd,
                  ),
                  child: _buildVideoCard(_latestTVShows[index]),
                );
              },
            ),
          ),
          const SizedBox(height: AppConstants.spacingLg),
        ],
      ),
    );
  }

  Widget _buildSectionHeader(String title, VoidCallback onSeeAllTap) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: AppConstants.spacingMd),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            title,
            style: Theme.of(context).textTheme.titleLarge?.copyWith(
                  fontWeight: FontWeight.bold,
                ),
          ),
          TextButton(
            onPressed: onSeeAllTap,
            child: Text(
              AppLocalizations.of(context).seeAll,
              style: const TextStyle(color: AppColors.accent),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildVideoCard(Video video) {
    return GestureDetector(
      onTap: () {
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => VideoDetailScreen(video: video),
          ),
        );
      },
      child: SizedBox(
        width: AppConstants.movieCardWidth,
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
          Expanded(
            child: ClipRRect(
              borderRadius: BorderRadius.circular(AppConstants.radiusMd),
              child: Stack(
                fit: StackFit.expand,
                children: [
                  if (video.pic.isNotEmpty)
                    Image.network(
                      video.pic,
                      fit: BoxFit.cover,
                      errorBuilder: (context, error, stackTrace) {
                        return Container(
                          color: AppColors.primaryMedium,
                          child: const Icon(Icons.movie, color: AppColors.textSecondary),
                        );
                      },
                    ),
                  if (video.displayScore > 0)
                    Positioned(
                      top: 8,
                      right: 8,
                      child: Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 8,
                          vertical: 4,
                        ),
                        decoration: BoxDecoration(
                          color: Colors.black.withValues(alpha: 0.7),
                          borderRadius: BorderRadius.circular(AppConstants.radiusSm),
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            const Icon(Icons.star, color: Colors.amber, size: 12),
                            const SizedBox(width: 4),
                            Text(
                              video.formattedScore,
                              style: const TextStyle(
                                color: Colors.white,
                                fontSize: 12,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  if (video.remarks != null && video.remarks!.isNotEmpty)
                    Positioned(
                      top: 8,
                      left: 8,
                      child: Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 8,
                          vertical: 4,
                        ),
                        decoration: BoxDecoration(
                          color: AppColors.accent.withValues(alpha: 0.9),
                          borderRadius: BorderRadius.circular(AppConstants.radiusSm),
                        ),
                        child: Text(
                          video.remarks!,
                          style: const TextStyle(
                            color: Colors.white,
                            fontSize: 11,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    ),
                ],
              ),
            ),
          ),
          const SizedBox(height: AppConstants.spacingSm),
          Text(
            video.name,
            style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                  fontWeight: FontWeight.w600,
                ),
            maxLines: 2,
            overflow: TextOverflow.ellipsis,
          ),
            if (video.year != null && video.year!.isNotEmpty)
              Text(
                video.year!,
                style: Theme.of(context).textTheme.bodySmall?.copyWith(
                      color: AppColors.textSecondary,
                    ),
              ),
          ],
        ),
      ),
    );
  }
}
